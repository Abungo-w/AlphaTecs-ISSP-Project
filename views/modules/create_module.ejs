<!DOCTYPE html>
<html>
<head>
    <title>Create New Module</title>
    <link rel="stylesheet" href="/css/module_create.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>
    <div class="module-creation-wrapper">
        <div class="module-creation-header">
            <h1>Create New Module</h1>
        </div>
        
        <form action="/modules/create" method="POST" onsubmit="return prepareSubmission()">
            <!-- Basic Module Info -->
            <div class="form-group">
                <label for="moduleCode">Module Code</label>
                <input type="text" id="moduleCode" name="moduleCode" class="form-input" 
                       required pattern="M-\d{2}-\d{2}-\d{2}" placeholder="M-36-58-74">
            </div>

            <div class="form-group">
                <label for="title">Module Title</label>
                <input type="text" id="title" name="title" class="form-input" required 
                       placeholder="e.g., Construction Project Management">
            </div>

            <div class="form-group">
                <label for="description">Module Description</label>
                <textarea id="description" name="description" class="form-input" rows="3" required></textarea>
            </div>

            <div class="form-group">
                <label for="duration">Estimated Duration</label>
                <div class="duration-inputs">
                    <input type="number" id="duration" name="duration" class="form-input duration-input" 
                           required min="5" max="480" value="30">
                    <span class="duration-unit">minutes</span>
                </div>
                <p class="field-description">Estimate how long this module will take to complete (5-480 minutes)</p>
            </div>

            <!-- Module Content -->
            <div class="form-group">
                <label>Content Sections</label>
                <div id="sections-container">
                    <!-- Section boxes will be added here -->
                </div>
                <button type="button" class="btn-add" onclick="addSection()">
                    + Add New Section
                </button>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">Create Module</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        let editors = [];
        
        function addSection() {
            const container = document.getElementById('sections-container');
            const sectionId = Date.now();
            
            const sectionWrapper = document.createElement('div');
            sectionWrapper.className = 'section-wrapper';
            sectionWrapper.id = `section-${sectionId}`;
            
            sectionWrapper.innerHTML = `
                <div class="section-header">
                    <input type="text" class="form-input section-title" 
                           placeholder="Section Title" required>
                    <button type="button" class="btn-remove" 
                            onclick="removeSection('section-${sectionId}')">Ã—</button>
                </div>
                <div id="editor-${sectionId}" class="editor-container"></div>
            `;
            
            container.appendChild(sectionWrapper);
            
            const editor = new Quill(`#editor-${sectionId}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        ['code-block', 'blockquote'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'header': [1, 2, 3, false] }],
                        ['link', 'image']
                    ]
                },
                placeholder: 'Enter section content...'
            });
            
            editors.push({
                id: sectionId,
                editor: editor
            });
        }

        function removeSection(sectionId) {
            document.getElementById(sectionId).remove();
            editors = editors.filter(e => `section-${e.id}` !== sectionId);
        }

        function prepareSubmission() {
            if (editors.length === 0) {
                alert('Please add at least one section to the module.');
                return false;
            }

            const sections = [];
            let isValid = true;
            
            editors.forEach(({ id, editor }) => {
                const sectionElement = document.getElementById(`section-${id}`);
                const titleElement = sectionElement.querySelector('.section-title');
                
                if (!titleElement.value.trim()) {
                    isValid = false;
                    titleElement.classList.add('error');
                }
                
                if (!editor.root.innerHTML.trim()) {
                    isValid = false;
                    editor.root.classList.add('error');
                }
                
                sections.push({
                    title: titleElement.value,
                    content: editor.root.innerHTML
                });
            });

            if (!isValid) {
                alert('Please fill in all section titles and content.');
                return false;
            }

            const sectionsInput = document.createElement('input');
            sectionsInput.type = 'hidden';
            sectionsInput.name = 'sections';
            sectionsInput.value = JSON.stringify(sections);
            
            document.querySelector('form').appendChild(sectionsInput);
            return true;
        }

        // Add initial section automatically
        addSection();
    </script>
</body>
</html>
